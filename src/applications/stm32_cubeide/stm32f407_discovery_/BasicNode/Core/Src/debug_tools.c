
#include "debug_tools.h"

#include "stdio.h"

#include "./src/drivers/common/can_types.h"
#include "./src/openlcb/openlcb_defines.h"
#include "./src/openlcb/openlcb_types.h"


void delay_pin_toggle(void) {

   

    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");  


    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");


    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");


    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");


    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");
    asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");asm(" NOP");

}

void PrintInt64(uint64_t n) {

    printf("0x%04X", (uint16_t) ((n >> 48) & 0xFFFF));
    printf("%04X", (uint16_t) ((n >> 32) & 0xFFFF));
    printf("%04X", (uint16_t) ((n >> 16) & 0xFFFF));
    printf("%04X\n", (uint16_t) ((n >> 0) & 0xFFFF));

}

void PrintAlias(uint16_t alias) {

    printf("Alias: %04X\n", alias);

}

void PrintNodeID(uint64_t node_id) {

    printf("NodeID: 0x%04X", (uint16_t) (node_id >> 32));
    printf("%04X", (uint16_t) (node_id >> 16));
    printf("%04X\n", (uint16_t) (node_id >> 0));

}

void PrintAliasAndNodeID(uint16_t alias, uint64_t node_id) {

    PrintAlias(alias);
    PrintNodeID(node_id);

}

void PrintMtiName(uint16_t mti) {
    switch (mti) {
        case MTI_INITIALIZATION_COMPLETE:
            printf("MTI_INITIALIZATION_COMPLETE");
            break;
        case MTI_INITIALIZATION_COMPLETE_SIMPLE:
            printf("MTI_INITIALIZATION_COMPLETE_SIMPLE");
            break;
        case MTI_VERIFY_NODE_ID_ADDRESSED:
            printf("MTI_VERIFY_NODE_ID_ADDRESSED");
            break;
        case MTI_VERIFY_NODE_ID_GLOBAL:
            printf("MTI_VERIFY_NODE_ID_GLOBAL");
            break;
        case MTI_VERIFIED_NODE_ID:
            printf("MTI_VERIFIED_NODE_ID");
            break;
        case MTI_VERIFIED_NODE_ID_SIMPLE:
            printf("MTI_VERIFIED_NODE_ID_SIMPLE");
            break;
        case MTI_OPTIONAL_INTERACTION_REJECTED:
            printf("MTI_OPTIONAL_INTERACTION_REJECTED");
            break;
        case MTI_TERMINATE_DO_TO_ERROR:
            printf("MTI_TERMINATE_DO_TO_ERROR");
            break;
        case MTI_PROTOCOL_SUPPORT_INQUIRY:
            printf("MTI_PROTOCOL_SUPPORT_INQUIRY");
            break;
        case MTI_PROTOCOL_SUPPORT_REPLY:
            printf("MTI_PROTOCOL_SUPPORT_REPLY");
            break;
        case MTI_CONSUMER_IDENTIFY:
            printf("MTI_CONSUMER_IDENTIFY");
            break;
        case MTI_CONSUMER_RANGE_IDENTIFIED:
            printf("MTI_CONSUMER_RANGE_IDENTIFIED");
            break;
        case MTI_CONSUMER_IDENTIFIED_UNKNOWN:
            printf("MTI_CONSUMER_IDENTIFIED_UNKNOWN");
            break;
        case MTI_CONSUMER_IDENTIFIED_SET:
            printf("MTI_CONSUMER_IDENTIFIED_SET");
            break;
        case MTI_CONSUMER_IDENTIFIED_CLEAR:
            printf("MTI_CONSUMER_IDENTIFIED_CLEAR");
            break;
        case MTI_CONSUMER_IDENTIFIED_RESERVED:
            printf("MTI_CONSUMER_IDENTIFIED_RESERVED");
            break;
        case MTI_PRODUCER_IDENTIFY:
            printf("MTI_PRODUCER_IDENTIFY");
            break;
        case MTI_PRODUCER_RANGE_IDENTIFIED:
            printf("MTI_PRODUCER_RANGE_IDENTIFIED");
            break;
        case MTI_PRODUCER_IDENTIFIED_UNKNOWN:
            printf("MTI_PRODUCER_IDENTIFIED_UNKNOWN");
            break;
        case MTI_PRODUCER_IDENTIFIED_SET:
            printf("MTI_PRODUCER_IDENTIFIED_SET");
            break;
        case MTI_PRODUCER_IDENTIFIED_CLEAR:
            printf("MTI_PRODUCER_IDENTIFIED_CLEAR");
            break;
        case MTI_PRODUCER_IDENTIFIED_RESERVED:
            printf("MTI_PRODUCER_IDENTIFIED_RESERVED");
            break;
        case MTI_EVENTS_IDENTIFY_DEST:
            printf("MTI_EVENTS_IDENTIFY_DEST");
            break;
        case MTI_EVENTS_IDENTIFY:
            printf("MTI_EVENTS_IDENTIFY");
            break;
        case MTI_EVENT_LEARN:
            printf("MTI_EVENT_LEARN");
            break;
        case MTI_PC_EVENT_REPORT:
            printf("MTI_PC_EVENT_REPORT");
            break;
        case MTI_SIMPLE_NODE_INFO_REQUEST:
            printf("MTI_SIMPLE_NODE_INFO_REQUEST");
            break;
        case MTI_SIMPLE_NODE_INFO_REPLY:
            printf("MTI_SIMPLE_NODE_INFO_REPLY");
            break;
        case MTI_SIMPLE_TRAIN_INFO_REQUEST:
            printf("MTI_SIMPLE_TRAIN_INFO_REQUEST");
            break;
        case MTI_SIMPLE_TRAIN_INFO_REPLY:
            printf("MTI_SIMPLE_TRAIN_INFO_REPLY");
            break;
        case MTI_TRACTION_PROTOCOL:
            printf("MTI_TRACTION_PROTOCOL");
            break;
        case MTI_TRACTION_REPLY:
            printf("MTI_TRACTION_REPLY ");
            break;
        case MTI_STREAM_INIT_REQUEST:
            printf("MTI_STREAM_INIT_REQUEST");
            break;
        case MTI_STREAM_INIT_REPLY:
            printf("MTI_STREAM_INIT_REPLY");
            break;
        case MTI_FRAME_TYPE_CAN_STREAM_SEND:
            printf("MTI_FRAME_TYPE_CAN_STREAM_SEND");
            break;
        case MTI_STREAM_PROCEED:
            printf("MTI_STREAM_PROCEED");
            break;
        case MTI_STREAM_COMPLETE:
            printf("MTI_STREAM_COMPLETE");
            break;
        case MTI_DATAGRAM:
            printf("MTI_DATAGRAM");
            break;
        case MTI_DATAGRAM_OK_REPLY:
            printf("MTI_DATAGRAM_OK_REPLY");
            break;
        case MTI_DATAGRAM_REJECTED_REPLY:
            printf("MTI_DATAGRAM_REJECTED_REPLY");
            break;
        default:
            printf("[UNKNOWN MTI]");
            break;
    };

    printf("\n");
};

void PrintOpenLcbMsg(openlcb_msg_t* openlcb_msg) {

    if (openlcb_msg) {

        printf("Source : ");
        PrintAliasAndNodeID(openlcb_msg->source_alias, openlcb_msg->source_id);
        printf("Dest : ");
        PrintAliasAndNodeID(openlcb_msg->dest_alias, openlcb_msg->dest_id);
        printf("mti : %04X\n", openlcb_msg->mti);
        PrintMtiName(openlcb_msg->mti);
        printf("Payload Count: %d = ", openlcb_msg->payload_count);
        printf("0x");
        for (int i = 0; i < openlcb_msg->payload_count; i++)
            printf("%02X", ((uint8_t*) openlcb_msg->payload)[i]);
        printf("\n");
        if (openlcb_msg->state.allocated)
            printf("Allocated: True\n");
        else
            printf("Allocated: False\n");

    }

}

void PrintCanMsg(can_msg_t* can_msg) {

    printf("Identifier: ");

    printf("0x%04X", (uint16_t) (can_msg->identifier >> 16));
    printf("%04X", (uint16_t) (can_msg->identifier));

    printf(";  Buffer Count: %d  ", can_msg->payload_count);

    printf("[ ");
    for (int i = 0; i < can_msg->payload_count; i++) {

        if (i < (can_msg->payload_count - 1)) {

            printf("%02X.", can_msg->payload[i]);

        } else {
        
            printf("%02X", can_msg->payload[i]);

        }

    }
    printf(" ]");

}

void PrintNode(openlcb_node_t* node) {
    
    printf("State Info\n");
    printf("  allocated = 0x%02X\n", node->state.allocated);
    printf("  permitted = 0x%02X\n", node->state.permitted);
    printf("  initialized = 0x%02X\n", node->state.initialized);
    printf("  duplicate_id_detected = 0x%02X\n", node->state.duplicate_id_detected);
    printf("  openlcb_datagram_ack_sent = 0x%02X\n", node->state.openlcb_datagram_ack_sent);
    printf("  resend_datagram = 0x%02X\n", node->state.resend_datagram);
    printf("  State = %d\n", node->state.run_state);
    
    printf("ID: ");
    PrintInt64(node->id);
    printf("Alias: %04X\n", node->alias);
    printf("Parameters: 0x%p\n", node->parameters);
    printf("Sent Datagrams: 0x%p\n", &node->last_received_datagram);
    if (node->last_received_datagram)
      PrintOpenLcbMsg(node->last_received_datagram);
    else
        printf("  null\n");
    printf("NodeLock ID: ");
    PrintInt64(node->owner_node);
    printf("Timer Ticks: %u", node->timerticks);
     
}

void PrintEventID(event_id_t event_id) {

    printf("EventID: 0x%04X", (uint16_t) (event_id >> 48));
    printf("%04X", (uint16_t) (event_id >> 32));
    printf("%04X", (uint16_t) (event_id >> 16));
    printf("%04X\n", (uint16_t) (event_id >> 0));

}

void PrintCanFrameIdentifierName(uint32_t identifier) {


    if (identifier & 0xFF000000 & ~RESERVED_TOP_BIT) {

        switch (identifier & 0xFF000000 & ~RESERVED_TOP_BIT) {

            case CAN_CONTROL_FRAME_CID1:
                printf("CAN_CONTROL_FRAME_CID1\n");
                return;
            case CAN_CONTROL_FRAME_CID2:
                printf("CAN_CONTROL_FRAME_CID2\n");
                return;
            case CAN_CONTROL_FRAME_CID3:
                printf("CAN_CONTROL_FRAME_CID3\n");
                return;
            case CAN_CONTROL_FRAME_CID4:
                printf("CAN_CONTROL_FRAME_CID4\n");
                return;
            case CAN_CONTROL_FRAME_CID5:
                printf("CAN_CONTROL_FRAME_CID5\n");
                return;
            case CAN_CONTROL_FRAME_CID6:
                printf("CAN_CONTROL_FRAME_CID6\n");
                return;
            case CAN_CONTROL_FRAME_CID7:
                printf("CAN_CONTROL_FRAME_CID7\n");
                return;
            default:
                printf("[UNKNOWN]\n");
                return;

        }

    }


    switch (identifier & 0xFFFFF000 & ~RESERVED_TOP_BIT) {

        case CAN_CONTROL_FRAME_AMD:
            printf("CAN_CONTROL_FRAME_AMD\n");
            return;
        case CAN_CONTROL_FRAME_AME:
            printf("CAN_CONTROL_FRAME_AME\n");
            return;
        case CAN_CONTROL_FRAME_AMR:
            printf("CAN_CONTROL_FRAME_AMR\n");
            return;
        case CAN_CONTROL_FRAME_RID:
            printf("CAN_CONTROL_FRAME_RID\n");
            return;
        case CAN_CONTROL_FRAME_ERROR_INFO_REPORT_0:
            printf("CAN_CONTROL_FRAME_ERROR_INFO_REPORT_0\n");
            return;
        case CAN_CONTROL_FRAME_ERROR_INFO_REPORT_1:
            printf("CAN_CONTROL_FRAME_ERROR_INFO_REPORT_1\n");
            return;
        case CAN_CONTROL_FRAME_ERROR_INFO_REPORT_2:
            printf("CAN_CONTROL_FRAME_ERROR_INFO_REPORT_2\n");
            return;
        case CAN_CONTROL_FRAME_ERROR_INFO_REPORT_3:
            printf("CAN_CONTROL_FRAME_ERROR_INFO_REPORT_3\n");
            return;
        default:
            printf("[UNKNOWN]\n");
            return;

    }

}

void PrintCanIdentifier(uint32_t identifier) {

    printf("0x%04X", (uint16_t) (identifier >> 16));
    printf("%04X\n", (uint16_t) (identifier));

}

void PrintDWord(uint32_t dword) {

    PrintCanIdentifier(dword);

}

