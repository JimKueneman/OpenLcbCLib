<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenLcbCLib: src/openlcb/openlcb_gridconnect.c File Reference</title>
<link rel="icon" href="Diesel.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">OpenLcbCLib<span id="projectnumber">&#160;1.0 Alpha</span>
   </div>
   <div id="projectbrief">OpenSource C Library to create OpenLcb/Lcc Nodes</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_2e7e6c944bd9908e2f8181efb624bb5a.html">openlcb</a></li>  </ul>
</div>
</div><!-- top -->
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">openlcb_gridconnect.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Implementation of GridConnect protocol conversion.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a82a8ee605795f44a733eeef5552fc746" id="r_a82a8ee605795f44a733eeef5552fc746"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a82a8ee605795f44a733eeef5552fc746">OpenLcbGridConnect_copy_out_gridconnect_when_done</a> (uint8_t next_byte, <a class="el" href="openlcb__gridconnect_8h.html#a4c98183f234e8c8860bc48872c2c01b8">gridconnect_buffer_t</a> *gridconnect_buffer)</td></tr>
<tr class="memdesc:a82a8ee605795f44a733eeef5552fc746"><td class="mdescLeft">&#160;</td><td class="mdescRight">Processes incoming GridConnect byte stream and extracts complete message.  <br /></td></tr>
<tr class="separator:a82a8ee605795f44a733eeef5552fc746"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac3e0b7b9ac71d9305e9481a35be9c452" id="r_ac3e0b7b9ac71d9305e9481a35be9c452"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ac3e0b7b9ac71d9305e9481a35be9c452">OpenLcbGridConnect_to_can_msg</a> (<a class="el" href="openlcb__gridconnect_8h.html#a4c98183f234e8c8860bc48872c2c01b8">gridconnect_buffer_t</a> *gridconnect_buffer, <a class="el" href="can__types_8h.html#a9fec363f8b39411fc3ce3bafd7182309">can_msg_t</a> *can_msg)</td></tr>
<tr class="memdesc:ac3e0b7b9ac71d9305e9481a35be9c452"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts a GridConnect message string to a CAN message structure.  <br /></td></tr>
<tr class="separator:ac3e0b7b9ac71d9305e9481a35be9c452"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adde8b0f53e353940974e4624ed1b32c2" id="r_adde8b0f53e353940974e4624ed1b32c2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#adde8b0f53e353940974e4624ed1b32c2">OpenLcbGridConnect_from_can_msg</a> (<a class="el" href="openlcb__gridconnect_8h.html#a4c98183f234e8c8860bc48872c2c01b8">gridconnect_buffer_t</a> *gridconnect_buffer, <a class="el" href="can__types_8h.html#a9fec363f8b39411fc3ce3bafd7182309">can_msg_t</a> *can_msg)</td></tr>
<tr class="memdesc:adde8b0f53e353940974e4624ed1b32c2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts a CAN message structure to GridConnect format string.  <br /></td></tr>
<tr class="separator:adde8b0f53e353940974e4624ed1b32c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation of GridConnect protocol conversion. </p>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright (c) 2024, Jim Kueneman All rights reserved.</dd></dl>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</p>
<ul>
<li>Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</li>
</ul>
<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<p>This module implements the GridConnect protocol, a human-readable ASCII encoding of CAN bus messages. The protocol is widely used in OpenLCB systems for serial and TCP/IP communication, debugging, and bridging applications.</p>
<p>Implementation features:</p><ul>
<li>Stateful streaming parser for byte-by-byte reception</li>
<li>Automatic error detection and recovery</li>
<li>Bidirectional conversion between CAN and GridConnect formats</li>
<li>No dynamic memory allocation</li>
<li>Single-threaded design (not thread-safe)</li>
</ul>
<p>The parser state machine handles:</p><ul>
<li>Message synchronization (finding ':X' start sequence)</li>
<li>Hexadecimal validation for identifier and data</li>
<li>Length validation (8-char identifier, even data byte count)</li>
<li>Automatic error recovery by resetting to start state</li>
</ul>
<p>GridConnect Protocol Format: </p><div class="fragment"><div class="line">:X&lt;8-hex-ID&gt;N&lt;hex-data&gt;;</div>
<div class="line"> </div>
<div class="line">Example: :X19170640N0501010107015555;</div>
<div class="line">  :       - Start delimiter</div>
<div class="line">  X       - Extended frame indicator</div>
<div class="line">  19170640 - 29-bit CAN identifier (8 hex chars)</div>
<div class="line">  N       - Normal priority flag</div>
<div class="line">  050101... - Data bytes (2 hex chars per <span class="keywordtype">byte</span>)</div>
<div class="line">  ;       - End delimiter</div>
</div><!-- fragment --><dl class="section author"><dt>Author</dt><dd>Jim Kueneman </dd></dl>
<dl class="section date"><dt>Date</dt><dd>28 Feb 2026</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="openlcb__gridconnect_8h.html" title="Bidirectional conversion between CAN messages and GridConnect ASCII format (:X&lt;8-hex-ID&gt;N&lt;hex-data&gt;;)...">openlcb_gridconnect.h</a> - Public interface </dd>
<dd>
<a class="el" href="can__types_8h.html" title="Type definitions and constants for the CAN transport layer.">can_types.h</a> - CAN message structures </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a82a8ee605795f44a733eeef5552fc746" name="a82a8ee605795f44a733eeef5552fc746"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a82a8ee605795f44a733eeef5552fc746">&#9670;&#160;</a></span>OpenLcbGridConnect_copy_out_gridconnect_when_done()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool OpenLcbGridConnect_copy_out_gridconnect_when_done </td>
          <td>(</td>
          <td class="paramtype">uint8_t</td>          <td class="paramname"><span class="paramname"><em>next_byte</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="openlcb__gridconnect_8h.html#a4c98183f234e8c8860bc48872c2c01b8">gridconnect_buffer_t</a> *</td>          <td class="paramname"><span class="paramname"><em>gridconnect_buffer</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Processes incoming GridConnect byte stream and extracts complete message. </p>
<p>Feeds one byte into the streaming GridConnect parser.</p>
<p>Algorithm: Implements a three-state parser that processes GridConnect protocol data one byte at a time:</p><ol type="1">
<li>SYNC_START: Wait for 'X'/'x', store ':X' prefix, advance to FIND_HEADER</li>
<li>SYNC_FIND_HEADER: Collect 8 hex chars for CAN ID, expect 'N' at position 10</li>
<li>SYNC_FIND_DATA: Collect hex data until ';', validate even count, copy to output</li>
</ol>
<p>Use cases:</p><ul>
<li>Serial port receive interrupt handlers calling once per received byte</li>
<li>TCP/IP socket data processing with partial packet reception</li>
</ul>
<pre class="fragment">* @param next_byte Next byte from the incoming GridConnect stream
* @param gridconnect_buffer Pointer to buffer where complete message will be stored
* </pre><dl class="section return"><dt>Returns</dt><dd>true when a complete valid GridConnect message has been extracted </dd>
<dd>
false while still collecting data or after recovering from errors</dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>NOT thread-safe â€” uses static variables for parser state</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="openlcb__gridconnect_8h.html#ac3e0b7b9ac71d9305e9481a35be9c452" title="Converts a validated GridConnect string to a can_msg_t.">OpenLcbGridConnect_to_can_msg</a> - Convert extracted GridConnect to CAN message </dd></dl>

</div>
</div>
<a id="ac3e0b7b9ac71d9305e9481a35be9c452" name="ac3e0b7b9ac71d9305e9481a35be9c452"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac3e0b7b9ac71d9305e9481a35be9c452">&#9670;&#160;</a></span>OpenLcbGridConnect_to_can_msg()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void OpenLcbGridConnect_to_can_msg </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="openlcb__gridconnect_8h.html#a4c98183f234e8c8860bc48872c2c01b8">gridconnect_buffer_t</a> *</td>          <td class="paramname"><span class="paramname"><em>gridconnect_buffer</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="can__types_8h.html#a9fec363f8b39411fc3ce3bafd7182309">can_msg_t</a> *</td>          <td class="paramname"><span class="paramname"><em>can_msg</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts a GridConnect message string to a CAN message structure. </p>
<p>Converts a validated GridConnect string to a <a class="el" href="can__types_8h.html#a9fec363f8b39411fc3ce3bafd7182309">can_msg_t</a>.</p>
<p>Algorithm:</p><ol type="1">
<li>Validate message length is at least GRIDCONNECT_HEADER_LEN</li>
<li>Extract 8-char hex identifier via strtoul()</li>
<li>Calculate payload byte count from remaining hex characters</li>
<li>Extract data bytes in pairs via strtoul()</li>
</ol>
<p>Use cases:</p><ul>
<li>Processing received GridConnect messages from serial/TCP</li>
<li>Converting logged GridConnect data to CAN for replay</li>
</ul>
<pre class="fragment">* @param gridconnect_buffer Pointer to GridConnect message buffer (null-terminated)
* @param can_msg Pointer to CAN message structure to populate
* </pre><dl class="section warning"><dt>Warning</dt><dd>Input must be a valid GridConnect message from the parser </dd>
<dd>
Pointers must NOT be NULL</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="openlcb__gridconnect_8h.html#a82a8ee605795f44a733eeef5552fc746" title="Feeds one byte into the streaming GridConnect parser.">OpenLcbGridConnect_copy_out_gridconnect_when_done</a> - Extract valid messages </dd>
<dd>
<a class="el" href="openlcb__gridconnect_8h.html#adde8b0f53e353940974e4624ed1b32c2" title="Converts a can_msg_t to a null-terminated GridConnect string.">OpenLcbGridConnect_from_can_msg</a> - Reverse conversion </dd></dl>

</div>
</div>
<a id="adde8b0f53e353940974e4624ed1b32c2" name="adde8b0f53e353940974e4624ed1b32c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adde8b0f53e353940974e4624ed1b32c2">&#9670;&#160;</a></span>OpenLcbGridConnect_from_can_msg()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void OpenLcbGridConnect_from_can_msg </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="openlcb__gridconnect_8h.html#a4c98183f234e8c8860bc48872c2c01b8">gridconnect_buffer_t</a> *</td>          <td class="paramname"><span class="paramname"><em>gridconnect_buffer</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="can__types_8h.html#a9fec363f8b39411fc3ce3bafd7182309">can_msg_t</a> *</td>          <td class="paramname"><span class="paramname"><em>can_msg</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts a CAN message structure to GridConnect format string. </p>
<p>Converts a <a class="el" href="can__types_8h.html#a9fec363f8b39411fc3ce3bafd7182309">can_msg_t</a> to a null-terminated GridConnect string.</p>
<p>Algorithm:</p><ol type="1">
<li>Write ":X" start sequence</li>
<li>Format 32-bit CAN identifier as 8-char uppercase hex</li>
<li>Append "N" normal priority flag</li>
<li>Format each payload byte as 2-char uppercase hex</li>
<li>Append ";" terminator</li>
</ol>
<p>Use cases:</p><ul>
<li>Transmitting CAN messages over serial/TCP connections</li>
<li>Logging CAN traffic in human-readable format</li>
</ul>
<pre class="fragment">* @param gridconnect_buffer Pointer to buffer where GridConnect message will be stored
* @param can_msg Pointer to source CAN message structure to convert
* </pre><dl class="section warning"><dt>Warning</dt><dd>Pointers must NOT be NULL </dd>
<dd>
Payload count must not exceed 8</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="openlcb__gridconnect_8h.html#ac3e0b7b9ac71d9305e9481a35be9c452" title="Converts a validated GridConnect string to a can_msg_t.">OpenLcbGridConnect_to_can_msg</a> - Reverse conversion </dd></dl>

</div>
</div>
</div><!-- contents -->
<!doctype html>
<html>
    <body>
        <hr>
        <p style="margin-left: 10px; margin-right: 10px;">
            <b>Copyright (c)</b> 2026 Jim Kueneman all rights reserved. See the <a href="../licence.html">License</a>
        </p>
    </body>
</html>
